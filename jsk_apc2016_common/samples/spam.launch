<launch>
  <param name="/robot_description"
         command="$(find xacro)/xacro.py $(find jsk_arc2017_baxter)/robots/baxter.xacro" />
  <param name="/use_sim_time" value="true" />
  <node name="rosbag_play"
        pkg="rosbag" type="play" args="--clock --loop /home/naoya/Downloads/baxter_stow_20170630.bag" />
  <node name="rviz" pkg="rviz" type="rviz" args="-d $(find jsk_arc2017_baxter)/euslisp/lib/spam.rviz" />

  <arg name="NODELET_MANAGER" value="/right_hand_camera/left/left_nodelet_manager" />
  <arg name="fuse" value="true" />

  <group ns="right_hand_camera">
    <group ns="left">
      <group ns="rgb">
        <node name="republish_rgb_image_raw"
              pkg="image_transport" type="republish"
              args="compressed raw">
          <remap from="in" to="image_raw" />
	  <remap from="out" to="image_raw" />
        </node>
      </group>
      <group ns="depth_registered">
        <node name="republish_depth_registered_image_raw"
              pkg="image_transport" type="republish"
              args="compressedDepth raw">
          <remap from="in" to="image_raw" />
	  <remap from="out" to="image_raw" />
        </node>
      </group>
    </group>
    <include file="$(find openni2_launch)/launch/openni2.launch">
      <arg name="camera" value="left" />
      <arg name="load_driver" value="false" />
      <arg name="depth_registration" value="true" />
    </include>

    <group ns="right">
      <group ns="rgb">
        <node name="republish_rgb_image_raw"
              pkg="image_transport" type="republish"
              args="compressed raw">
          <remap from="in" to="image_raw" />
	  <remap from="out" to="image_raw" />
        </node>
      </group>
      <group ns="depth_registered">
        <node name="republish_depth_registered_image_raw"
              pkg="image_transport" type="republish"
              args="compressedDepth raw">
          <remap from="in" to="image_raw" />
	  <remap from="out" to="image_raw" />
        </node>
      </group>
    </group>
    <include file="$(find openni2_launch)/launch/openni2.launch">
      <arg name="camera" value="right" />
      <arg name="load_driver" value="false" />
      <arg name="depth_registration" value="true" />
    </include>
  </group>

  <group ns="right_hand_camera">
    <!-- stereo depth creation -->
    <group ns="stereo">
      <node name="relay_rgb_camera_info"
            pkg="nodelet" type="nodelet"
            args="load jsk_topic_tools/Relay /$(arg NODELET_MANAGER)">
        <remap from="~input" to="/right_hand_camera/left/rgb/camera_info" />
        <remap from="~output" to="rgb/camera_info" />
      </node>
      <node name="stereo_image_proc"
            pkg="stereo_image_proc" type="stereo_image_proc" >
        <remap from="left/camera_info" to="/right_hand_camera/left/rgb/camera_info" />
        <remap from="right/camera_info" to="/right_hand_camera/right/rgb/camera_info" />
        <remap from="left/image_raw" to="/right_hand_camera/left/rgb/image_raw" />
        <remap from="right/image_raw" to="/right_hand_camera/right/rgb/image_raw" />
        <remap from="points2" to="depth_registered/points" />
        <rosparam>
          approximate_sync: true
        </rosparam>
      </node>
      <node name="depth_image_creator"
            pkg="nodelet" type="nodelet"
            args="load jsk_pcl/DepthImageCreator /$(arg NODELET_MANAGER)"
            output="screen" >
        <remap from="~input" to="depth_registered/points" />
        <remap from="~info" to="/right_hand_camera/left/rgb/camera_info" />
        <remap from="~output" to="depth_registered/image_rect" />
        <remap from="~output_image" to="rgb/image_rect_color" />
        <rosparam>
          use_approximate: true
          max_queue_size: 10
        </rosparam>
      </node>
      <group ns="depth_registered">
        <node name="image_rect_view"
              pkg="image_view" type="image_view">
          <remap from="image" to="image_rect" />
          <remap from="~output" to="~" />
          <rosparam>
            gui: false
            min_image_value: 0.5
            max_image_value: 1.0
            colormap: 2
          </rosparam>
        </node>
      </group>
    </group>

    <!-- stereo rgb-d fusion -->
    <group ns="right_registered">
      <node name="relay_rgb_camera_info"
            pkg="nodelet" type="nodelet"
            args="load jsk_topic_tools/Relay /$(arg NODELET_MANAGER)">
        <remap from="~input" to="/right_hand_camera/left/rgb/camera_info" />
        <remap from="~output" to="rgb/camera_info" />
      </node>
      <node name="depth_image_creator"
            pkg="nodelet" type="nodelet"
            args="load jsk_pcl/DepthImageCreator /$(arg NODELET_MANAGER)"
            output="screen" >
        <remap from="~input" to="/right_hand_camera/right/depth_registered/points" />
        <remap from="~info" to="rgb/camera_info" />
        <remap from="~output" to="depth_registered/image_rect" />
        <remap from="~output_image" to="rgb/image_rect_color" />
        <rosparam>
          use_approximate: true
          max_queue_size: 10
        </rosparam>
      </node>
      <group ns="depth_registered">
        <node name="image_rect_view"
              pkg="image_view" type="image_view">
          <remap from="image" to="image_rect" />
          <remap from="~output" to="~" />
          <rosparam>
            gui: false
            min_image_value: 0.5
            max_image_value: 1.0
            colormap: 2
          </rosparam>
        </node>
      </group>
    </group>  <!-- ns: right -->
    <group ns="fused" if="$(arg fuse)">
      <node name="relay_rgb_camera_info"
            pkg="nodelet" type="nodelet"
            args="load jsk_topic_tools/Relay /$(arg NODELET_MANAGER)">
        <remap from="~input" to="/right_hand_camera/left/rgb/camera_info" />
        <remap from="~output" to="rgb/camera_info" />
      </node>
      <node name="fuse_rgb_images"
            pkg="nodelet" type="nodelet"
            args="load jsk_pcl/FuseRGBImages /$(arg NODELET_MANAGER)"
            output="screen" >
        <remap from="~output" to="rgb/image_rect_color" />
        <rosparam>
          approximate_sync: true
          averaging: false
          queue_size: 50
          input_topics:
            - /right_hand_camera/right_registered/rgb/image_rect_color
            - /right_hand_camera/stereo/rgb/image_rect_color
            - /right_hand_camera/left/rgb/image_rect_color
        </rosparam>
      </node>
      <node name="fuse_depth_images"
            pkg="nodelet" type="nodelet"
            args="load jsk_pcl/FuseDepthImages /$(arg NODELET_MANAGER)"
            output="screen" >
        <remap from="~output" to="depth_registered/image_rect" />
        <rosparam>
          approximate_sync: true
          averaging: true
          queue_size: 50
          input_topics:
            - /right_hand_camera/right_registered/depth_registered/image_rect
            - /right_hand_camera/stereo/depth_registered/image_rect
            - /right_hand_camera/left/depth_registered/hw_registered/image_rect_raw
        </rosparam>
      </node>
      <group ns="depth_registered">
        <node name="image_rect_view"
              pkg="image_view" type="image_view">
          <remap from="image" to="image_rect" />
          <remap from="~output" to="~" />
          <rosparam>
            gui: false
            min_image_value: 0.5
            max_image_value: 1.0
            colormap: 2
          </rosparam>
        </node>
      </group>
      <node name="point_cloud_xyzrgb"
            pkg="nodelet" type="nodelet"
            args="load depth_image_proc/point_cloud_xyzrgb /$(arg NODELET_MANAGER)"
            output="screen" >
        <remap from="rgb/camera_info" to="rgb/camera_info" />
        <remap from="rgb/image_rect_color" to="rgb/image_rect_color" />
        <remap from="depth_registered/image_rect" to="depth_registered/image_rect" />
        <remap from="depth_registered/points" to="depth_registered/points" />
        <rosparam>
          queue_size: 50
          approximate_sync: true
        </rosparam>
      </node>
    </group>  <!-- ns: fused -->
  </group>  <!-- ns: right_hand_camera -->
</launch>
